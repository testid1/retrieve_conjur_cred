name: Conjur OIDC Auth

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  conjur-auth:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 1: Get OIDC Token with correct audience
      - name: Request GitHub OIDC Token
        id: oidc
        uses: actions/github-script@v7
        with:
          script: |
            const token = await core.getIDToken("conjur");  # <-- Replace with your actual Conjur audience
            if (!token) {
              core.setFailed("OIDC token retrieval failed");
            }
            core.setOutput("jwt", token);

      # üêû Optional: Debug JWT token claims
      - name: Decode and display JWT payload
        run: |
          echo "${{ steps.oidc.outputs.jwt }}" | \
          awk -F '.' '{print $2}' | base64 -d | jq

      # ‚úÖ Step 2: Authenticate to Conjur
      - name: Authenticate to Conjur
        id: conjur_auth
        env:
          CONJUR_URL: "https://pwclab.secretsmgr.cyberark.cloud/api"
          CONJUR_AUTHN_ID: "JWTwithGITHUB"
          CONJUR_ACCOUNT: "conjur"
          JWT: ${{ steps.oidc.outputs.jwt }}
        run: |
          set -euo pipefail

          if [[ -z "$JWT" ]]; then
            echo "‚ùå ERROR: JWT token is empty"
            exit 1
          fi

          echo "üîê Authenticating to Conjur..."
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            "$CONJUR_URL/authn-jwt/$CONJUR_AUTHN_ID/$CONJUR_ACCOUNT/authenticate" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "jwt=$JWT")

          HTTP_BODY=$(echo "$RESPONSE" | sed -n '/^HTTP_STATUS:/!p')
          HTTP_STATUS=$(echo "$RESPONSE" | sed -n 's/^HTTP_STATUS://p')

          if [[ "$HTTP_STATUS" != "200" ]]; then
            echo "‚ùå ERROR: Conjur authentication failed with status $HTTP_STATUS"
            echo "Response body: $HTTP_BODY"
            exit 1
          fi

          echo "$HTTP_BODY" > session_token.txt
          echo "session_token=$HTTP_BODY" >> $GITHUB_OUTPUT
          echo "‚úÖ Session token obtained successfully."
          echo "üìù Token written to file (bytes: $(wc -c < session_token.txt))"

      # üîç Step 3: Verify token file
      - name: Show session token
        run: |
          echo "üìÑ Session token content:"
          cat session_token.txt

      # üì¶ Step 4: Upload token
      - name: Upload raw session token
        uses: actions/upload-artifact@v4
        with:
          name: raw-session-token
          path: session_token.txt

      # ‚úÖ Step 5: Retrieve secret from Conjur
      - name: Retrieve secret from Conjur
        id: get_secret
        env:
          CONJUR_URL: "https://pwclab.secretsmgr.cyberark.cloud/api"
          CONJUR_ACCOUNT: "conjur"
          VAR: "data/vault/conjurtest/conjurtest/address"
          SESSION_TOKEN: ${{ steps.conjur_auth.outputs.session_token }}
        run: |
          set -euo pipefail

          if [[ -z "$SESSION_TOKEN" ]]; then
            echo "‚ùå ERROR: Session token is empty"
            exit 1
          fi

          echo "üîç Retrieving secret for variable: $VAR"
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -k \
            -H "Authorization: Token token=\"$SESSION_TOKEN\"" \
            "$CONJUR_URL/secrets/$CONJUR_ACCOUNT/variable/$VAR")

          HTTP_BODY=$(echo "$RESPONSE" | sed -n '/^HTTP_STATUS:/!p')
          HTTP_STATUS=$(echo "$RESPONSE" | sed -n 's/^HTTP_STATUS://p')

          if [[ "$HTTP_STATUS" != "200" ]]; then
            echo "‚ùå ERROR: Failed to retrieve secret (HTTP $HTTP_STATUS)"
            echo "Response body: $HTTP_BODY"
            exit 1
          fi

          echo "$HTTP_BODY" > secret_value.txt
          echo "‚úÖ Secret retrieved successfully: $HTTP_BODY"
          echo "secret_value=$HTTP_BODY" >> $GITHUB_OUTPUT

      # üì¶ Step 6: Upload secret
      - name: Upload retrieved secret
        uses: actions/upload-artifact@v4
        with:
          name: raw-secret
          path: secret_value.txt
