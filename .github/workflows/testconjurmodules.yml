name: Conjur OIDC Auth

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  get-oidc-token:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Debug OIDC environment variables (optional)
        run: |
          echo "Token: $ACTIONS_ID_TOKEN_REQUEST_TOKEN"
          echo "URL: $ACTIONS_ID_TOKEN_REQUEST_URL"

      - name: Request JWT from GitHub
        id: jwt
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            -H "Accept: application/json" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL")

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

          JWT=$(echo "$RESPONSE" | jq -r .value)
          echo "jwt=$JWT" >> $GITHUB_OUTPUT

      - name: Authenticate to Conjur using JWT
        id: conjur_auth
        run: |
          CONJUR_URL="https://pwclab.secretsmgr.cyberark.cloud/api"
          SESSION_TOKEN=$(curl -s -X POST "$CONJUR_URL/authn-jwt/JWTwithGITHUB/conjur/authenticate" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "jwt=${{ steps.jwt.outputs.jwt }}")

          echo "session_token=$SESSION_TOKEN" >> $GITHUB_OUTPUT
          echo "$SESSION_TOKEN" > session_token.txt
          echo "Session token file written with $(wc -c < session_token.txt) bytes"

      - name: Verify session token file before upload
        run: |
          ls -l session_token.txt
          cat session_token.txt

      - name: Upload session token as artifact
        uses: actions/upload-artifact@v4
        with:
          name: raw-st
          path: session_token.txt

      - name: Retrieve secret from Conjur
        shell: bash
        env:
          CONJUR_URL: "https://pwclab.secretsmgr.cyberark.cloud/api"
          CONJUR_ACCOUNT: "conjur"
        run: |
          set -e
          SESSION_TOKEN=$(cat session_token.txt)
          VAR="data/vault/conjurtest/conjurtest/address"

          SECRET_VALUE=$(curl -s -k \
            -H "Authorization: Token token=\"$SESSION_TOKEN\"" \
            "$CONJUR_URL/secrets/conjur/variable/${VAR}")

          echo "Secret=$SECRET_VALUE" >> $GITHUB_OUTPUT
          echo "$SECRET_VALUE" > secret_value.txt
          echo "Secret: $SECRET_VALUE"

      - name: Upload retrieved secret as artifact
        uses: actions/upload-artifact@v4
        with:
          name: raw-secret
          path: secret_value.txt
