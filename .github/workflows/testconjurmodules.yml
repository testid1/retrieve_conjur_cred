name: Conjur OIDC Auth

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  get-oidc-token:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ✅ Use GitHub Script to get OIDC JWT token
      - name: Request GitHub OIDC Token
        id: oidc
        uses: actions/github-script@v7
        with:
          script: |
            const token = await core.getIDToken("conjur");
            core.setOutput("jwt", token);

      # ✅ Authenticate to Conjur using JWT
      - name: Authenticate to Conjur
        id: conjur_auth
        env:
          CONJUR_URL: "https://pwclab.secretsmgr.cyberark.cloud/api"
          CONJUR_AUTHN_ID: "JWTwithGITHUB"
          CONJUR_ACCOUNT: "conjur"
          JWT: ${{ steps.oidc.outputs.jwt }}
        run: |
          SESSION_TOKEN=$(curl -s -X POST "$CONJUR_URL/authn-jwt/$CONJUR_AUTHN_ID/$CONJUR_ACCOUNT/authenticate" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "jwt=$JWT")

          echo "session_token=$SESSION_TOKEN" >> $GITHUB_OUTPUT
          echo "$SESSION_TOKEN" > session_token.txt
          echo "Session token file written with $(wc -c < session_token.txt) bytes"

      # 🔍 Optional: Debug token file before upload
      - name: Show session token file
        run: |
          ls -l session_token.txt
          cat session_token.txt

      # 📦 Upload session token as artifact
      - name: Upload raw session token
        uses: actions/upload-artifact@v4
        with:
          name: raw-session-token
          path: session_token.txt

      # 🔐 Retrieve secret from Conjur
      - name: Retrieve secret from Conjur
        id: get_secret
        env:
          CONJUR_URL: "https://pwclab.secretsmgr.cyberark.cloud/api"
          CONJUR_ACCOUNT: "conjur"
          SESSION_TOKEN: ${{ steps.conjur_auth.outputs.session_token }}
        run: |
          VAR="data/vault/conjurtest/conjurtest/address"
          SECRET_VALUE=$(curl -s -k \
            -H "Authorization: Token token=\"$SESSION_TOKEN\"" \
            "$CONJUR_URL/secrets/$CONJUR_ACCOUNT/variable/$VAR")
          echo "Secret=$SECRET_VALUE" >> $GITHUB_OUTPUT
          echo "$SECRET_VALUE" > secret_value.txt

      # 📦 Upload retrieved secret as artifact
      - name: Upload retrieved secret
        uses: actions/upload-artifact@v4
        with:
          name: raw-secret
          path: secret_value.txt
